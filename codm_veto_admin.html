<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CODM — Map Veto (Admin View)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --bg:#05060a; --panel:#141828; --panel2:#191e30;
    --ink:#f6f7fb; --muted:#9ca3c7;
    --brand:#ffe93b; --accent:#7fd2ff;
    --ban:#ff6b6b; --pick:#62e887;
    --line:#272b3f;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    background:#05060a;
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  }
  body{padding:16px}

  .shell{
    max-width:980px;
    margin:0 auto;
    background:radial-gradient(circle at top,#1b2035 0,#05060a 52%);
    border-radius:16px;
    padding:18px 18px 20px;
    border:1px solid #262a3c;
    box-shadow:0 22px 60px rgba(0,0,0,.8);
  }
  h1{
    font-size:1.4rem;
    margin-bottom:4px;
  }
  .sub{
    font-size:.85rem;
    color:var(--muted);
    margin-bottom:14px;
  }

  .grid{
    display:grid;
    grid-template-columns:1.1fr .9fr;
    gap:12px;
  }
  @media(max-width:768px){
    .grid{grid-template-columns:1fr}
  }

  .panel{
    background:var(--panel);
    border-radius:12px;
    padding:12px 14px;
    border:1px solid var(--line);
  }
  .panel h2{
    font-size:.95rem;
    margin-bottom:8px;
    letter-spacing:.04em;
    text-transform:uppercase;
    color:#d2d8ff;
  }
  .row{display:flex;justify-content:space-between;gap:6px;font-size:.88rem;margin-bottom:4px}
  .row label{color:var(--muted)}
  .row span.value{font-weight:600;color:var(--ink)}

  .phase{
    margin-top:4px;
    padding:6px 10px;
    border-radius:8px;
    background:linear-gradient(90deg,#20263a,#151a28);
    border:1px solid #323853;
    font-size:.85rem;
  }
  .phase span.label{
    text-transform:uppercase;
    letter-spacing:.06em;
    font-size:.7rem;
    color:var(--muted);
  }
  .phase span.value{
    display:block;
    margin-top:2px;
    font-weight:600;
  }

  .bans, .summary-text{
    margin-top:6px;
    font-size:.85rem;
  }
  .bans div, .summary-text div{margin-bottom:2px}

  .map-badge{
    display:inline-flex;
    align-items:center;
    gap:4px;
    border-radius:999px;
    padding:2px 8px;
    font-size:.78rem;
    border:1px solid var(--line);
    background:var(--panel2);
  }
  .map-badge.ban{border-color:#ff6b6b99;color:#ffc2c2}
  .map-badge.pick{border-color:#62e887aa;color:#bdf7d2}
  .map-badge small{color:var(--muted);font-size:.7rem}

  .ticker{
    margin-top:10px;
    padding:6px 8px;
    border-radius:8px;
    border:1px dashed #3c425a;
    font-size:.8rem;
    color:var(--muted);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:4px;
    border-radius:999px;
    padding:3px 9px;
    font-size:.75rem;
    border:1px solid var(--line);
    color:var(--muted);
  }
  .pill strong{color:var(--ink);font-weight:600}
</style>
</head>
<body>
<div class="shell">
  <h1>CODM Map Veto — Admin View</h1>
  <div class="sub">
    This page is read-only. Open the Teams page in another tab on the same browser to drive the veto.  
    Changes will appear here automatically.
  </div>

  <div class="grid">
    <div class="panel">
      <h2>Match Info</h2>
      <div class="row">
        <label>Team 1:</label><span class="value" id="t1Name">—</span>
      </div>
      <div class="row">
        <label>Team 2:</label><span class="value" id="t2Name">—</span>
      </div>
      <div class="row">
        <label>Coin Call:</label><span class="value" id="coinCall">—</span>
      </div>
      <div class="row">
        <label>Coin Result:</label><span class="value" id="coinResult">—</span>
      </div>
      <div class="row">
        <label>Coin Winner:</label><span class="value" id="coinWinner">—</span>
      </div>
      <div class="row">
        <label>Start Team:</label><span class="value" id="startTeam">—</span>
      </div>
      <div class="row">
        <label>Wait Team:</label><span class="value" id="waitTeam">—</span>
      </div>

      <div class="phase">
        <span class="label">Current Phase</span>
        <span class="value" id="phaseLabel">—</span>
      </div>

      <div class="ticker" id="tickerText">
        Waiting for the Teams page to start the session.
      </div>
    </div>

    <div class="panel">
      <h2>Bans, Pick & Side</h2>
      <div class="bans" id="bansBlock">
        No bans yet.
      </div>
      <div style="margin-top:6px;">
        <div class="row">
          <label>Picked Map:</label><span class="value" id="pickedMap">—</span>
        </div>
        <div class="row">
          <label>Side Choice:</label><span class="value" id="sideChoice">—</span>
        </div>
      </div>

      <div class="summary-text" id="summaryBlock" style="margin-top:8px;">
        <!-- summary lines -->
      </div>

      <div style="margin-top:10px;">
        <span class="pill">
          Session ID:&nbsp;<strong id="sessionId">—</strong>
        </span>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = 'codm_veto_state_v1';

  function defaultState(){
    return {
      seriesId: null,
      team1Name: '',
      team2Name: '',
      coinCaller: 'team1',
      coinCall: null,
      coinResult: null,
      coinWinner: null,
      startTeam: null,
      waitTeam: null,
      phase: 'setup',
      turnTeam: null,
      bans: [],
      pick: null,
      side: null
    };
  }

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    try{
      const s = JSON.parse(raw);
      return Object.assign(defaultState(), s);
    }catch(e){
      return defaultState();
    }
  }

  let state = loadState();

  const t1NameEl = document.getElementById('t1Name');
  const t2NameEl = document.getElementById('t2Name');
  const coinCallEl = document.getElementById('coinCall');
  const coinResultEl = document.getElementById('coinResult');
  const coinWinnerEl = document.getElementById('coinWinner');
  const startTeamEl = document.getElementById('startTeam');
  const waitTeamEl = document.getElementById('waitTeam');
  const phaseLabelEl = document.getElementById('phaseLabel');
  const tickerTextEl = document.getElementById('tickerText');
  const bansBlockEl = document.getElementById('bansBlock');
  const pickedMapEl = document.getElementById('pickedMap');
  const sideChoiceEl = document.getElementById('sideChoice');
  const summaryBlockEl = document.getElementById('summaryBlock');
  const sessionIdEl = document.getElementById('sessionId');

  function teamName(key){
    if(key === 'team1') return state.team1Name || 'Team 1';
    if(key === 'team2') return state.team2Name || 'Team 2';
    return '';
  }

  function phaseLabel(phase){
    switch(phase){
      case 'setup': return 'Setup';
      case 'coin': return 'Coin Flip';
      case 'choose_role': return 'Coin Winner Chooses Start / Wait';
      case 'ban1': return 'Ban #1';
      case 'ban2': return 'Ban #2';
      case 'pick': return 'Map Pick';
      case 'side': return 'Side Selection';
      case 'done': return 'Completed';
      default: return '—';
    }
  }

  function phaseTickerText(){
    switch(state.phase){
      case 'setup':
        return 'Waiting for team names and coin flip to begin.';
      case 'coin':
        return 'Team 1 is choosing Heads/Tails and flipping the coin.';
      case 'choose_role':
        return 'Coin winner is choosing whether to START bans or WAIT & pick side.';
      case 'ban1':
        return teamName(state.startTeam) + ' is banning the first map.';
      case 'ban2':
        return teamName(state.waitTeam) + ' is banning the second map.';
      case 'pick':
        return teamName(state.startTeam) + ' is picking the final map.';
      case 'side':
        return teamName(state.waitTeam) + ' is choosing RED or BLUE side.';
      case 'done':
        return 'Veto completed. Use the summary for broadcast graphics or overlays.';
      default:
        return 'Waiting for the Teams page to start the session.';
    }
  }

  function render(){
    state = loadState();

    t1NameEl.textContent = state.team1Name || '—';
    t2NameEl.textContent = state.team2Name || '—';

    // coin
    if(state.coinCall){
      const caller = teamName('team1'); // Team 1 always calls
      coinCallEl.textContent = caller + ' called ' + state.coinCall;
    }else{
      coinCallEl.textContent = '—';
    }
    coinResultEl.textContent = state.coinResult || '—';
    coinWinnerEl.textContent = state.coinWinner ? teamName(state.coinWinner) : '—';

    startTeamEl.textContent = state.startTeam ? teamName(state.startTeam) : '—';
    waitTeamEl.textContent = state.waitTeam ? teamName(state.waitTeam) : '—';

    phaseLabelEl.textContent = phaseLabel(state.phase);
    tickerTextEl.textContent = phaseTickerText();

    // bans
    if(!state.bans || !state.bans.length){
      bansBlockEl.textContent = 'No bans yet.';
    }else{
      bansBlockEl.innerHTML = state.bans.map((b, i) => {
        return '<div><span class="map-badge ban">Ban '+(i+1)+': '+b.map+
          ' <small>by '+teamName(b.team)+'</small></span></div>';
      }).join('');
    }

    // pick
    if(state.pick){
      pickedMapEl.textContent = teamName(state.pick.team) + ' picked ' + state.pick.map;
    }else{
      pickedMapEl.textContent = '—';
    }

    // side
    if(state.side){
      sideChoiceEl.textContent = teamName(state.side.team) + ' chose ' + state.side.choice + ' side.';
    }else{
      sideChoiceEl.textContent = '—';
    }

    // summary
    const lines = [];
    lines.push('Matchup: ' + (state.team1Name || 'Team 1') + ' vs ' + (state.team2Name || 'Team 2'));

    if(state.coinCall){
      lines.push('Coin: Team 1 called ' + state.coinCall +
        ' → result ' + (state.coinResult || '—') +
        (state.coinWinner ? ' → winner ' + teamName(state.coinWinner) : ''));
    }

    if(state.startTeam && state.waitTeam){
      lines.push('Roles: Start — ' + teamName(state.startTeam) +
        ', Wait — ' + teamName(state.waitTeam));
    }

    if(state.bans && state.bans.length){
      state.bans.forEach((b,i) => {
        lines.push('Ban '+(i+1)+': '+teamName(b.team)+' banned '+b.map);
      });
    }

    if(state.pick){
      lines.push('Picked Map: ' + teamName(state.pick.team) + ' picked ' + state.pick.map);
    }

    if(state.side){
      lines.push('Side: ' + teamName(state.side.team) + ' chose ' + state.side.choice);
    }

    if(state.phase === 'done'){
      lines.push('Status: Veto complete.');
    }else{
      lines.push('Status: In progress (' + phaseLabel(state.phase) + ').');
    }

    summaryBlockEl.innerHTML = lines.map(l => '<div>'+l+'</div>').join('');

    sessionIdEl.textContent = state.seriesId ? String(state.seriesId) : '—';
  }

  // update on storage events from the Teams tab
  window.addEventListener('storage', (e) => {
    if(e.key === STORAGE_KEY){
      render();
    }
  });

  // also poll every 1.5s as a backup
  setInterval(render, 1500);

  render();
})();
</script>
</body>
</html>
