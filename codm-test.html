<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>COD:M — Map Layouts (Caster Reference)</title>

<style>
  :root{
    --bg:#0d1014; --panel:#1b2130; --panel2:#121724;
    --ink:#eef3fb; --muted:#b6c0ce; --line:#343c4b;
    --brand:#ffe93b; --accent:#7fd2ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}

  /* Header */
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#131823 0%,#0d1014 100%);border-bottom:2px solid var(--brand)}
  .head{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:12px}
  .logo{height:28px;aspect-ratio:auto;display:block}
  h1{margin:0;font-size:1.05rem;letter-spacing:.2px}
  .spacer{flex:1}
  .btn{background:var(--brand);color:#0b0f14;border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.secondary{background:#171d2a;color:#dbe3f0;border:1px solid var(--line)}
  a.btn{display:inline-flex;align-items:center;gap:8px;text-decoration:none}

  /* Layout */
  .shell{max-width:1200px;margin:16px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:1000px){ .grid{grid-template-columns:360px 1fr} }

  /* Panels */
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .panel h2{margin:0 0 8px 0;font-size:1rem}

  /* Search */
  .search{display:flex;gap:8px;margin-bottom:10px}
  .search input{flex:1;background:#0f1421;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px}

  /* Buttons */
  .mode-section{margin-bottom:10px}
  .mode-title{margin:6px 0 8px 0;font-weight:800;color:#fff}
  .map-list{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(min-width:520px){ .map-list{grid-template-columns:1fr 1fr 1fr} }
  .map-btn{
    background:#0f1524;border:1px solid var(--line);color:#dfe7f5;border-radius:12px;
    padding:10px 10px; text-align:center; cursor:pointer; user-select:none;
    transition:transform .05s ease, border-color .2s ease, background .2s ease;
  }
  .map-btn:hover{transform:translateY(-1px);border-color:#4b9bd6}
  .map-btn.active{background:#152036;border-color:var(--accent);box-shadow:0 0 0 2px #152036, 0 0 0 4px rgba(127,210,255,.25) inset}

  /* Viewer */
  .viewer{background:var(--panel2);border:1px solid var(--line);border-radius:14px;padding:10px}
  .viewer-head{display:flex;align-items:center;gap:10px;margin:0 0 10px 0}
  .viewer-title{font-weight:800}
  .viewer-tools{margin-left:auto;display:flex;gap:8px}
  .viewer-tools a, .viewer-tools button{font-size:.9rem}
  .img-wrap{
    width:100%;height:72vh;min-height:360px;background:#0a0e18;border:1px solid var(--line);
    border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;
    touch-action:none; /* enables custom pinch/drag on mobile */
    position:relative;cursor:grab;
  }
  .img-wrap.grabbing{cursor:grabbing}
  .img-wrap img{
    max-width:none;max-height:none; /* we control fit via transform now */
    user-select:none; -webkit-user-drag:none;
    will-change:transform;
    transform-origin:0 0;
    display:block;
  }
  .muted{color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="head">
    <img src="https://i.imgur.com/K0TTjUC.png" alt="COD:M logo" class="logo" />
    <h1>COD:M — Map Layouts (Caster Reference)</h1>
    <div class="spacer"></div>
    <a class="btn secondary" href="index.html" title="Back to Home">⟵ Back to Home</a>
  </div>
</header>

<div class="shell">
  <div class="grid">
    <!-- Left: maps grouped by mode -->
    <section class="panel">
      <h2>Maps</h2>
      <div class="search">
        <input id="q" type="search" placeholder="Filter maps…" />
        <button class="btn secondary" id="clearBtn">Clear</button>
      </div>
      <div id="groups"></div>
      <p class="muted" id="countNote" style="margin-top:8px"></p>
    </section>

    <!-- Right: viewer -->
    <section class="viewer">
      <div class="viewer-head">
        <div class="viewer-title" id="title">Select a map</div>
        <div class="viewer-tools">
          <button class="btn secondary" id="zoomOut" title="Zoom out">−</button>
          <button class="btn secondary" id="zoomIn" title="Zoom in">+</button>
          <button class="btn secondary" id="resetZoom" title="Reset view">Reset</button>
          <a id="downloadLink" class="btn" href="#" download>Download</a>
        </div>
      </div>
      <div class="img-wrap" id="viewer">
        <img id="img" alt="Map layout preview" />
      </div>
      <p class="muted" style="margin-top:10px">
        Gestures: pinch to zoom, drag to pan, double-tap/click to zoom, wheel to zoom (desktop). Use ↑/↓ or ←/→ to switch maps.
      </p>
    </section>
  </div>
</div>

<script>
  /* === Source images === */
  const MAPS = [
    {name:'Coastal', url:'https://i.imgur.com/2JRlrj5.png'},
    {name:'Crossfire', url:'https://i.imgur.com/YYor9iP.png'},
    {name:'Firing Range', url:'https://i.imgur.com/QWJg4Ai.png'},
    {name:'Kurohana Metropolis', url:'https://i.imgur.com/eeYVgRp.png'},
    {name:'Raid', url:'https://i.imgur.com/cGh1ku0.png'},
    {name:'Standoff', url:'https://i.imgur.com/8gaEr2j.png'},
    {name:'Tunisia', url:'https://i.imgur.com/D23jrcJ.png'},
    {name:'Apocalypse', url:'https://i.imgur.com/djfhXIE.png'},
    {name:'Hacienda', url:'https://i.imgur.com/aOWvPKU.png'},
    {name:'Slums', url:'https://i.imgur.com/9y2NzWw.png'},
    {name:'Summit', url:'https://i.imgur.com/yevs7pE.png'},
    {name:'Takeoff', url:'https://i.imgur.com/zEuzP6E.jpeg'},
    {name:'Combine', url:'https://i.imgur.com/DtBhN36.png'}
  ];

  /* === Grouping by mode (buttons appear under each) === */
  const MAPS_BY_MODE = {
    'Hardpoint':        ['Summit','Hacienda','Apocalypse','Slums','Combine'],
    'Search & Destroy': ['Tunisia','Firing Range','Kurohana Metropolis','Standoff','Coastal'],
    'Control':          ['Raid','Takeoff','Crossfire']
  };
  const MODE_ORDER = ['Hardpoint','Search & Destroy','Control'];

  const groupsEl = document.getElementById('groups');
  const titleEl = document.getElementById('title');
  const imgEl = document.getElementById('img');
  const dlLink = document.getElementById('downloadLink');
  const q = document.getElementById('q');
  const clearBtn = document.getElementById('clearBtn');
  const countNote = document.getElementById('countNote');

  const viewer = document.getElementById('viewer');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const resetBtn = document.getElementById('resetZoom');

  let flatFiltered = [];
  let activeName = '';

  function findGlobalMap(name){
    return MAPS.find(m => m.name.toLowerCase() === name.toLowerCase());
  }

  /* -------- Pinch/Zoom/Pan (with bounds clamping) -------- */
  function createPanZoom(container, img){
    const state = {
      x: 0, y: 0, scale: 1,
      minScale: 1, maxScale: 5,
      pointers: new Map(),
      _pinch: null,
      lastTap: {t:0, x:0, y:0}
    };

    function dims(){
      const cw = container.clientWidth, ch = container.clientHeight;
      const iw = img.naturalWidth || cw, ih = img.naturalHeight || ch;
      const sw = iw * state.scale, sh = ih * state.scale;
      return {cw,ch,iw,ih,sw,sh};
    }

    function bounds(){
      const {cw,ch,sw,sh} = dims();
      // If image bigger than container: clamp edges to keep it covering the view
      // If smaller: force center (min==max)
      const minX = (sw > cw) ? (cw - sw) : (cw - sw)/2;
      const maxX = (sw > cw) ? 0 : (cw - sw)/2;
      const minY = (sh > ch) ? (ch - sh) : (ch - sh)/2;
      const maxY = (sh > ch) ? 0 : (ch - sh)/2;
      return {minX, maxX, minY, maxY};
    }

    function clampXY(){
      const b = bounds();
      state.x = Math.min(b.maxX, Math.max(b.minX, state.x));
      state.y = Math.min(b.maxY, Math.max(b.minY, state.y));
    }

    function setTransform(){
      clampXY();
      img.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
    }

    function fitToContain(){
      const {cw,ch,iw,ih} = dims();
      const s = Math.min(cw/iw, ch/ih) || 1;
      state.minScale = s;        // ✅ minimum zoom is "fit"
      state.scale = s;
      const sw = iw * s, sh = ih * s;
      state.x = (cw - sw)/2;
      state.y = (ch - sh)/2;
      setTransform();
    }

    function clampScale(s){ return Math.max(state.minScale, Math.min(state.maxScale, s)); }

    function pointInContainer(e){
      const r = container.getBoundingClientRect();
      return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    function zoomAt(focal, newScale){
      newScale = clampScale(newScale);
      const prev = state.scale;
      if (newScale === prev) return;

      // keep focal point stable while zooming
      const dx = focal.x - state.x;
      const dy = focal.y - state.y;
      state.x = focal.x - dx * (newScale/prev);
      state.y = focal.y - dy * (newScale/prev);
      state.scale = newScale;
      setTransform();
    }

    // Pointer handling (single drag, two-finger pinch)
    container.addEventListener('pointerdown', (e)=>{
      container.setPointerCapture(e.pointerID || e.pointerId);
      state.pointers.set(e.pointerId, {x:e.clientX, y:e.clientY, prevX:e.clientX, prevY:e.clientY});
      container.classList.add('grabbing');

      // double-tap / double-click zoom (toggles between minScale and ~2x)
      const now = Date.now();
      const p = pointInContainer(e);
      if (now - state.lastTap.t < 300 && Math.hypot(p.x-state.lastTap.x, p.y-state.lastTap.y) < 40){
        const target = (state.scale < state.minScale * 1.6) ? state.scale * 2 : state.minScale;
        zoomAt(p, target);
      }
      state.lastTap = {t: now, x: p.x, y: p.y};
    });

    container.addEventListener('pointermove', (e)=>{
      if (!state.pointers.has(e.pointerId)) return;
      e.preventDefault();

      const pt = state.pointers.get(e.pointerId);
      pt.x = e.clientX; pt.y = e.clientY;

      const pts = Array.from(state.pointers.values());
      if (pts.length === 1){
        // drag
        const dx = pt.x - pt.prevX;
        const dy = pt.y - pt.prevY;
        pt.prevX = pt.x; pt.prevY = pt.y;
        state.x += dx; state.y += dy;
        setTransform();
      } else if (pts.length >= 2){
        // pinch
        const [a,b] = pts;
        const dist = Math.hypot(b.x - a.x, b.y - a.y);
        const mid = { x:(a.x+b.x)/2, y:(a.y+b.y)/2 };

        if (!state._pinch){
          state._pinch = { dist, scale: state.scale, mid };
        } else {
          const ratio = dist / state._pinch.dist;
          const target = clampScale(state._pinch.scale * ratio);
          const focal = pointInContainer({clientX: state._pinch.mid.x, clientY: state._pinch.mid.y});
          zoomAt(focal, target);
        }
      }
    }, {passive:false});

    function endPointer(e){
      state.pointers.delete(e.pointerId);
      if (state.pointers.size < 2) state._pinch = null;
      if (state.pointers.size === 0) container.classList.remove('grabbing');
    }
    container.addEventListener('pointerup', endPointer);
    container.addEventListener('pointercancel', endPointer);
    container.addEventListener('pointerleave', endPointer);

    // Wheel zoom (desktop)
    container.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const delta = -Math.sign(e.deltaY) * 0.25; // step
      const focal = pointInContainer(e);
      zoomAt(focal, state.scale * (1 + delta));
    }, {passive:false});

    // Buttons
    zoomInBtn.addEventListener('click', ()=> zoomAt({x:container.clientWidth/2,y:container.clientHeight/2}, state.scale*1.25));
    zoomOutBtn.addEventListener('click',()=> zoomAt({x:container.clientWidth/2,y:container.clientHeight/2}, state.scale/1.25));
    resetBtn.addEventListener('click', fitToContain);

    // Refit on image load / resize
    img.addEventListener('load', fitToContain);
    window.addEventListener('resize', fitToContain);

    return { reset: fitToContain, zoomAt };
  }

  /* -------- UI wiring (maps + viewer) -------- */
  const pz = createPanZoom(viewer, imgEl);

  function renderGroups(){
    const term = (q.value||'').trim().toLowerCase();
    flatFiltered = [];
    groupsEl.innerHTML = '';

    MODE_ORDER.forEach(mode=>{
      const names = MAPS_BY_MODE[mode].filter(n => n.toLowerCase().includes(term));
      if (!names.length) return;

      const sec = document.createElement('div');
      sec.className = 'mode-section';

      const h = document.createElement('div');
      h.className = 'mode-title';
      h.textContent = mode;
      sec.appendChild(h);

      const list = document.createElement('div');
      list.className = 'map-list';

      names.forEach(n=>{
        const m = findGlobalMap(n);
        if (!m) return;
        flatFiltered.push(m.name);

        const b = document.createElement('button');
        b.className = 'map-btn';
        b.textContent = m.name;
        b.dataset.name = m.name;
        b.onclick = () => selectName(m.name);
        list.appendChild(b);
      });

      sec.appendChild(list);
      groupsEl.appendChild(sec);
    });

    const total = Object.values(MAPS_BY_MODE).flat().length;
    countNote.textContent = `${flatFiltered.length} of ${total} maps`;
    applyActiveStyle();

    if (flatFiltered.length && !flatFiltered.includes(activeName)){
      selectName(flatFiltered[0]);
    }
  }

  function selectName(name){
    const m = findGlobalMap(name);
    if (!m) return;
    activeName = m.name;
    titleEl.textContent = m.name;
    imgEl.src = m.url;
    imgEl.alt = `${m.name} map layout`;
    dlLink.href = m.url;
    applyActiveStyle();
    // pan/zoom resets to fit on image load
  }

  function applyActiveStyle(){
    groupsEl.querySelectorAll('.map-btn').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.name === activeName);
    });
  }

  function filterList(){ renderGroups(); }

  // Keyboard navigation across the flattened filtered order
  window.addEventListener('keydown', (e)=>{
    if (!flatFiltered.length) return;
    const idx = flatFiltered.indexOf(activeName);
    if (['ArrowDown','ArrowRight'].includes(e.key)){
      e.preventDefault();
      const next = (idx + 1 + flatFiltered.length) % flatFiltered.length;
      selectName(flatFiltered[next]);
    } else if (['ArrowUp','ArrowLeft'].includes(e.key)){
      e.preventDefault();
      const prev = (idx - 1 + flatFiltered.length) % flatFiltered.length;
      selectName(flatFiltered[prev]);
    }
  });

  // Preload images (nice-to-have)
  MAPS.forEach(m => { const im = new Image(); im.src = m.url; });

  q.addEventListener('input', filterList);
  clearBtn.addEventListener('click', ()=>{ q.value=''; filterList(); });

  // Initial render
  renderGroups();
  if (flatFiltered.length) selectName(flatFiltered[0]);
</script>
</body>
</html>

