<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>COD:M ‚Äî Player KDA Comparison</title>
<meta name="theme-color" content="#0d1014"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0d1014; --panel:#292d42; --panel2:#1e2432;
    --ink:#f3f6fa; --muted:#b8c0cc; --brand:#ffe93b; --brandText:#0b0d0e;
    --brand2:#ffffff; --line:#4c525d; --chip:#213830;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  a{color:var(--brand);text-decoration:none}
  a:hover{text-decoration:underline}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#141a23 0%,#0d1014 100%);border-bottom:2px solid var(--brand)}
  .head{display:flex;align-items:center;gap:14px;max-width:1240px;margin:0 auto;padding:12px 14px}
  .logo{width:36px;height:36px;border-radius:8px;object-fit:contain;background:#0d1014;border:1px solid #2a3144;box-shadow:0 6px 16px rgba(0,0,0,.35)}
  h1{margin:0;font-size:1.1rem;letter-spacing:.4px;color:var(--brand)}
  .push{margin-left:auto}

  .shell{max-width:1240px;margin:18px auto;padding:0 12px}
  .block{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
  .block h2{margin:0 0 8px 0;color:var(--brand2)}
  .muted{color:var(--muted)}

  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{background:var(--chip);border:1px solid var(--line);color:#d2efe1;border-radius:999px;padding:6px 10px;display:flex;gap:6px;align-items:center}
  .btn{background:var(--brand);color:#0c0e10;border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.secondary{background:#1a2030;color:#d6dbe6;border:1px solid var(--line)}
  .controls input,.controls select{background:#151b26;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:.9rem}

  /* layout */
  .grid2{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:1100px){ .grid2{grid-template-columns:1fr 1fr} }
  .panel{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:12px}
  .panel-title{display:flex;align-items:center;gap:10px;margin:0 0 8px 0}
  .tag{font-size:.75rem;border:1px solid var(--line);padding:2px 8px;border-radius:999px;background:#111827;color:#e7ecf5}

  /* STACK totals then averages to save width */
  .stack{display:grid;grid-template-columns:1fr;gap:10px}

  /* foldables */
  details.fold{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:8px;margin-top:10px}
  details.fold>summary{cursor:pointer;color:#e7ecf5;font-weight:700}

  /* compact table */
  .compact table{width:100%;border-collapse:collapse;font-size:.86rem;line-height:1.15}
  .compact thead th{background:#141a1f;position:sticky;top:0;z-index:1}
  .compact th,.compact td{border-bottom:1px solid #3a4255;padding:6px 8px;vertical-align:middle}
  .right{ text-align:right; font-variant-numeric: tabular-nums; }
  .nowrap{white-space:nowrap}
</style>
</head>
<body>
<header>
  <div class="head">
    <img src="https://i.imgur.com/K0TTjUC.png" alt="COD:M Logo" class="logo">
    <h1>COD:M ‚Äî Player KDA Comparison</h1>
    <a class="btn secondary push" href="index.html" title="Back to Home">‚Üê Home</a>
    <a class="btn secondary" href="#" id="resetBtn">Reset</a>
  </div>
</header>

<div class="shell">

  <!-- GLOBAL FILTERS -->
  <section class="block">
    <h2>Filters</h2>
    <div class="controls">
      <label class="chip">Team A
        <select id="teamA"></select>
      </label>
      <label class="chip">Team B
        <select id="teamB"></select>
      </label>
      <label class="chip">Mode
        <select id="fMode">
          <option value="ALL">All</option>
          <option value="HP">HP</option>
          <option value="SND">SND</option>
          <option value="CTRL">CTRL</option>
        </select>
      </label>
      <label class="chip">Map
        <select id="fMap"></select>
      </label>
      <button class="btn" id="applyBtn">Apply</button>
    </div>
    <div class="muted" id="meta">‚Äî</div>

    <!-- üìå Metrics note -->
    <details class="fold" style="margin-top:8px">
      <summary>What are K/D and KDA?</summary>
      <div class="muted" style="margin-top:6px; line-height:1.35">
        <p><strong>K/D</strong> = <em>Kills √∑ Deaths</em><br>
        Measures pure lethality/survivability. Assists don‚Äôt count.</p>

        <p><strong>KDA</strong> = <em>(Kills + Assists) √∑ Deaths</em><br>
        Credits both frags and assists, so supportive play shows up better.</p>
      </div>
    </details>
  </section>

  <!-- OVERALL SECTION -->
  <section class="block">
    <h2>Overall</h2>
    <div class="grid2">
      <!-- Panel A -->
      <div class="panel">
        <h3 class="panel-title"><span id="titleA">Team A</span> <span class="tag">Left</span></h3>
        <div class="compact">
          <div class="stack">
            <div>
              <h4 style="margin:4px 0 6px">Totals</h4>
              <div id="overallA_tot"></div>
            </div>
            <div>
              <h4 style="margin:12px 0 6px">Averages</h4>
              <div id="overallA_avg"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Panel B -->
      <div class="panel">
        <h3 class="panel-title"><span id="titleB">Team B</span> <span class="tag">Right</span></h3>
        <div class="compact">
          <div class="stack">
            <div>
              <h4 style="margin:4px 0 6px">Totals</h4>
              <div id="overallB_tot"></div>
            </div>
            <div>
              <h4 style="margin:12px 0 6px">Averages</h4>
              <div id="overallB_avg"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PER MODE: HP -->
  <details class="fold">
    <summary>Per Mode ‚Äî HP</summary>
    <div class="grid2" style="margin-top:10px">
      <div class="panel">
        <h3 class="panel-title"><span id="titleA_HP">Team A</span> <span class="tag">HP</span></h3>
        <div class="compact">
          <div class="stack">
            <div><h4 style="margin:4px 0 6px">Totals</h4><div id="modeA_HP_tot"></div></div>
            <div><h4 style="margin:12px 0 6px">Averages</h4><div id="modeA_HP_avg"></div></div>
          </div>
        </div>
      </div>
      <div class="panel">
        <h3 class="panel-title"><span id="titleB_HP">Team B</span> <span class="tag">HP</span></h3>
        <div class="compact">
          <div class="stack">
            <div><h4 style="margin:4px 0 6px">Totals</h4><div id="modeB_HP_tot"></div></div>
            <div><h4 style="margin:12px 0 6px">Averages</h4><div id="modeB_HP_avg"></div></div>
          </div>
        </div>
      </div>
    </div>
  </details>

  <!-- PER MODE: SND -->
  <details class="fold">
    <summary>Per Mode ‚Äî SND</summary>
    <div class="grid2" style="margin-top:10px">
      <div class="panel">
        <h3 class="panel-title"><span id="titleA_SND">Team A</span> <span class="tag">SND</span></h3>
        <div class="compact">
          <div class="stack">
            <div><h4 style="margin:4px 0 6px">Totals</h4><div id="modeA_SND_tot"></div></div>
            <div><h4 style="margin:12px 0 6px">Averages</h4><div id="modeA_SND_avg"></div></div>
          </div>
        </div>
      </div>
      <div class="panel">
        <h3 class="panel-title"><span id="titleB_SND">Team B</span> <span class="tag">SND</span></h3>
        <div class="compact">
          <div class="stack">
            <div><h4 style="margin:4px 0 6px">Totals</h4><div id="modeB_SND_tot"></div></div>
            <div><h4 style="margin:12px 0 6px">Averages</h4><div id="modeB_SND_avg"></div></div>
          </div>
        </div>
      </div>
    </div>
  </details>

  <!-- PER MODE: CTRL -->
  <details class="fold">
    <summary>Per Mode ‚Äî CTRL</summary>
    <div class="grid2" style="margin-top:10px">
      <div class="panel">
        <h3 class="panel-title"><span id="titleA_CTRL">Team A</span> <span class="tag">CTRL</span></h3>
        <div class="compact">
          <div class="stack">
            <div><h4 style="margin:4px 0 6px">Totals</h4><div id="modeA_CTRL_tot"></div></div>
            <div><h4 style="margin:12px 0 6px">Averages</h4><div id="modeA_CTRL_avg"></div></div>
          </div>
        </div>
      </div>
      <div class="panel">
        <h3 class="panel-title"><span id="titleB_CTRL">Team B</span> <span class="tag">CTRL</span></h3>
        <div class="compact">
          <div class="stack">
            <div><h4 style="margin:4px 0 6px">Totals</h4><div id="modeB_CTRL_tot"></div></div>
            <div><h4 style="margin:12px 0 6px">Averages</h4><div id="modeB_CTRL_avg"></div></div>
          </div>
        </div>
      </div>
    </div>
  </details>
</div>

<script>
/* ===== Supabase ===== */
const SUPA_URL = 'https://fjdyppkanjnvyscqrfum.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZHlwcGthbmpudnlzY3FyZnVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDU1NzIsImV4cCI6MjA3NTkyMTU3Mn0.ssEN7uA9BVm9AkhsjkWxhPzV1-VQVxc4-u7LS2wt4Aw';
const client = supabase.createClient(SUPA_URL, SUPA_KEY);

/* ===== Helpers ===== */
const el = id => document.getElementById(id);
const n  = v => { if(v==null||v==='') return 0; const t=Number(v); return isNaN(t)?0:t; };
const norm= v => (v==null ? '' : String(v)).trim();
const key = v => norm(v).toLowerCase();
const sum = (arr, k) => arr.reduce((a,r)=>a+n(typeof k==='function'?k(r):r[k]),0);

function distinct(rows,col){
  return Array.from(new Set(rows.map(r=>norm(r[col])).filter(Boolean)))
         .sort((a,b)=>a.localeCompare(b));
}
function groupBy(rows, keyFn){
  return rows.reduce((m,r)=>{ const k = keyFn(r); (m[k] ||= []).push(r); return m; },{});
}
function toMMSS(sec){
  const s = Math.max(0, Math.floor(n(sec))); const m = Math.floor(s/60); const ss=(s%60).toString().padStart(2,'0');
  return `${m}:${ss}`;
}
function fmt(x, d=2){ return (x==null || isNaN(x)) ? '0.00' : Number(x).toFixed(d); }
function ratio(a,b){ return b ? (a/b) : 0; }

/* ===== Data state ===== */
let RAW = [];
let TEAM_A = '', TEAM_B = '';
let MODE_SEL = 'ALL', MAP_SEL = 'ALL';

/* ===== Fetch (paged) ===== */
async function fetchAllKDA(){
  const step = 1000; let from = 0; const out = [];
  for(;;){
    const { data, error } = await client
      .from('kda_stats')
      .select('*')
      .order('id', { ascending:true })
      .range(from, from+step-1);
    if (error){ console.error(error); alert('Failed to load kda_stats: '+error.message); break; }
    const rows = (data||[]);
    out.push(...rows);
    if (rows.length < step) break;
    from += rows.length;
  }
  return out;
}

/* ===== Normalize one row ===== */
function coerceRow(r){
  const _mode = norm(r.mode || r.Mode);
  function normalizeMode(m){
    const s = key(m);
    if (s.includes('hp') || s.includes('hardpoint')) return 'HP';
    if (s.includes('snd') || s.includes('search')) return 'SND';
    if (s.includes('ctrl') || s.includes('ctl') || s.includes('control')) return 'CTRL';
    return _mode || '';
  }
  return {
    ...r,
    Team: norm(r.Team || r.team),
    Opponent: norm(r.Opponent || r.opponent),
    Map: norm(r.Map || r.map),
    mode: normalizeMode(_mode),
    IGN: norm(r.IGN || r.player || r.name),
    Kills: n(r.Kills ?? r.kills),
    Death: n(r.Death ?? r.deaths ?? r.DeathCount),
    Assist: n(r.Assist ?? r.assists),
    Score: n(r.Score ?? r.score),
    hill_Time: n(r.hill_Time ?? r.hill_time ?? r.hillSeconds ?? r.hill), // seconds
    Region: norm(r.Region || r.region),
    Day: norm(r.Day || r.day),
    ['Game-Match']: norm(r['Game-Match'] || r.GameMatch || r.gamematch || r.game),
    Role: norm(r.Role || r.role),
    id: r.id
  };
}

/* ===== Filters ===== */
function populateDropdowns(){
  const teams = distinct(RAW,'Team');
  el('teamA').innerHTML = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
  el('teamB').innerHTML = teams.map(t=>`<option value="${t}">${t}</option>`).join('');

  const maps = distinct(RAW,'Map');
  const mapOpts = `<option value="ALL">All</option>` + maps.map(m=>`<option value="${m}">${m}</option>`).join('');
  el('fMap').innerHTML = mapOpts;

  TEAM_A = teams[0] || '';
  TEAM_B = teams[1] || teams[0] || '';
  el('teamA').value = TEAM_A;
  el('teamB').value = TEAM_B;
}
function currentScopeRows(team){
  let rows = RAW.filter(r => r.Team === team);
  if (MODE_SEL !== 'ALL') rows = rows.filter(r => r.mode === MODE_SEL);
  if (MAP_SEL !== 'ALL')  rows = rows.filter(r => r.Map  === MAP_SEL);
  return rows;
}

/* ===== Aggregations (totals + per-game avgs) ===== */
function aggRows(list){
  const games = list.length;
  const kills = sum(list,'Kills');
  const deaths= sum(list,'Death');
  const assists = sum(list,'Assist');
  const scoreSum = sum(list,'Score');

  const kd = ratio(kills, deaths);
  const kda = ratio(kills + assists, Math.max(1,deaths));

  // HP hill totals & avg over HP games only
  const hpRows = list.filter(r => r.mode==='HP');
  const hpHillSum = sum(hpRows, 'hill_Time');
  const hpGames = hpRows.length;
  const avgHill = hpGames ? (hpHillSum / hpGames) : 0;

  return {
    games, kills, deaths, assists, kd, kda, scoreSum,
    hillSum: hpHillSum, avgHill,
    avgK: games ? kills/games : 0,
    avgD: games ? deaths/games : 0,
    avgA: games ? assists/games : 0,
    avgScore: games ? scoreSum/games : 0
  };
}
function aggByPlayer(rows){
  const g = groupBy(rows, r=>r.IGN);
  const out = Object.entries(g).map(([ign, list])=>{
    const a = aggRows(list);
    return {
      IGN: ign,
      games: a.games,
      // totals
      kills: a.kills, deaths: a.deaths, assists: a.assists,
      kd: a.kd, kda: a.kda, score: a.scoreSum, hill_sum: a.hillSum,
      // avgs
      avgK: a.avgK, avgD: a.avgD, avgA: a.avgA, avgScore: a.avgScore, avgHill: a.avgHill
    };
  });
  return out.sort((x,y)=> (y.kda-x.kda) || (y.kd-x.kd) || (y.games-x.games));
}
function aggByPlayerMode(rows, modeCode){
  const subset = rows.filter(r => r.mode===modeCode);
  const g = groupBy(subset, r=>r.IGN);
  const out = Object.entries(g).map(([ign, list])=>{
    const a = aggRows(list);
    return {
      IGN: ign,
      games: a.games,
      kills: a.kills, deaths: a.deaths, assists: a.assists,
      kd: a.kd, kda: a.kda, score: a.scoreSum, hill_sum: a.hillSum,
      avgK: a.avgK, avgD: a.avgD, avgA: a.avgA, avgScore: a.avgScore, avgHill: a.avgHill
    };
  });
  return out.sort((x,y)=> (y.kda-x.kda) || (y.kd-x.kd) || (y.games-x.games));
}

/* ===== Rendering with <colgroup> ===== */
function renderTable(hostId, rows, cols, empty='No rows.'){
  const host = el(hostId);
  if (!rows.length){ host.innerHTML = `<div class="muted">${empty}</div>`; return; }

  const colgroup = `<colgroup>${cols.map((_,i)=>`<col data-idx="${i}">`).join('')}</colgroup>`;
  const thead = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''} ${c.nowrap?'nowrap':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${
    rows.map(r=>`<tr>${cols.map(c=>{
      let v = (typeof c.value==='function') ? c.value(r) : r[c.key];
      if (c.format==='num')  v = (v==null||isNaN(v)) ? '0.00' : Number(v).toFixed(c.dp ?? 2);
      if (c.format==='mmss') v = toMMSS(v);
      return `<td class="${c.right?'right':''} ${c.nowrap?'nowrap':''}">${v ?? '‚Äî'}</td>`;
    }).join('')}</tr>`).join('')
  }</tbody>`;

  host.innerHTML = `<table>${colgroup}${thead}${tbody}</table>`;
}

/* ===== Column width sync (align first column + all cols per section) ===== */
function _maxColNaturalWidth(tbl, colIdx){
  if (!tbl) return 0;
  const head = tbl.tHead?.rows?.[0];
  const th = head?.cells?.[colIdx];
  let max = th ? th.getBoundingClientRect().width : 0;

  const rows = tbl.tBodies?.[0]?.rows || [];
  for (let i=0; i<rows.length; i++){
    const td = rows[i].cells[colIdx];
    if (!td) continue;
    const w = td.getBoundingClientRect().width;
    if (w > max) max = w;
    if (i > 50) break; // perf cap
  }
  return Math.max(48, Math.ceil(max));
}
function _clearColgroupWidths(tbl){
  const cols = tbl?.querySelectorAll('colgroup col') || [];
  cols.forEach(c => c.style.width = '');
}
function _applyWidths(tbl, widths){
  const cols = tbl?.querySelectorAll('colgroup col') || [];
  widths.forEach((w,i)=> { if (cols[i]) cols[i].style.width = `${w}px`; });
}
function _getTables(ids){ return ids.map(id => el(id)?.querySelector('table')).filter(Boolean); }

function syncGroup(ids){
  const tables = _getTables(ids);
  if (!tables.length) return;
  tables.forEach(_clearColgroupWidths);
  const cols = Math.min(...tables.map(t => t.tHead?.rows?.[0]?.cells?.length || 0));
  if (!cols) return;
  const widths = [];
  for (let i=0; i<cols; i++){
    let w = 0; tables.forEach(t => { w = Math.max(w, _maxColNaturalWidth(t, i)); });
    widths.push(w);
  }
  tables.forEach(t => _applyWidths(t, widths));
}

/* Section groups: Overall, HP, SND, CTRL */
function syncAllGroups(){
  const GROUPS = [
    ['overallA_tot','overallA_avg','overallB_tot','overallB_avg'],
    ['modeA_HP_tot','modeA_HP_avg','modeB_HP_tot','modeB_HP_avg'],
    ['modeA_SND_tot','modeA_SND_avg','modeB_SND_tot','modeB_SND_avg'],
    ['modeA_CTRL_tot','modeA_CTRL_avg','modeB_CTRL_tot','modeB_CTRL_avg'],
  ];
  requestAnimationFrame(()=> GROUPS.forEach(syncGroup));
}

/* ===== Panel rendering ===== */
function renderOverallPanels(rowsA, rowsB){
  // Titles
  el('titleA').textContent = TEAM_A || '‚Äî';
  el('titleB').textContent = TEAM_B || '‚Äî';

  const overallA = aggByPlayer(rowsA);
  const overallB = aggByPlayer(rowsB);

  const colsTotals = [
    {label:'Player', key:'IGN'},
    {label:'G', key:'games', right:true},
    {label:'K', key:'kills', right:true},
    {label:'D', key:'deaths', right:true},
    {label:'A', key:'assists', right:true},
    {label:'K/D', key:'kd', right:true, format:'num'},
    {label:'KDA', key:'kda', right:true, format:'num'},
    {label:'Score Œ£', key:'score', right:true, format:'num', dp:0},
    {label:'HP Hill Œ£', key:'hill_sum', right:true, format:'mmss', nowrap:true},
  ];
  const colsAverages = [
    {label:'Player', key:'IGN'},
    {label:'G', key:'games', right:true},
    {label:'Avg K', key:'avgK', right:true, format:'num'},
    {label:'Avg D', key:'avgD', right:true, format:'num'},
    {label:'Avg A', key:'avgA', right:true, format:'num'},
    {label:'Avg Score', key:'avgScore', right:true, format:'num'},
    {label:'Avg Hill', key:'avgHill', right:true, format:'mmss', nowrap:true},
  ];

  renderTable('overallA_tot', overallA, colsTotals, '‚Äî');
  renderTable('overallA_avg', overallA, colsAverages, '‚Äî');
  renderTable('overallB_tot', overallB, colsTotals, '‚Äî');
  renderTable('overallB_avg', overallB, colsAverages, '‚Äî');
}

function renderModePanels(rowsA, rowsB, mode){
  // Titles per mode
  if (mode==='HP'){ el('titleA_HP').textContent = TEAM_A; el('titleB_HP').textContent = TEAM_B; }
  if (mode==='SND'){ el('titleA_SND').textContent = TEAM_A; el('titleB_SND').textContent = TEAM_B; }
  if (mode==='CTRL'){ el('titleA_CTRL').textContent = TEAM_A; el('titleB_CTRL').textContent = TEAM_B; }

  const byA = aggByPlayerMode(rowsA, mode);
  const byB = aggByPlayerMode(rowsB, mode);

  const colsTotalsNoHill = [
    {label:'Player', key:'IGN'},
    {label:'G', key:'games', right:true},
    {label:'K', key:'kills', right:true},
    {label:'D', key:'deaths', right:true},
    {label:'A', key:'assists', right:true},
    {label:'K/D', key:'kd', right:true, format:'num'},
    {label:'KDA', key:'kda', right:true, format:'num'},
    {label:'Score Œ£', key:'score', right:true, format:'num', dp:0},
  ];
  const colsAveragesNoHill = [
    {label:'Player', key:'IGN'},
    {label:'G', key:'games', right:true},
    {label:'Avg K', key:'avgK', right:true, format:'num'},
    {label:'Avg D', key:'avgD', right:true, format:'num'},
    {label:'Avg A', key:'avgA', right:true, format:'num'},
    {label:'Avg Score', key:'avgScore', right:true, format:'num'},
  ];

  if (mode==='HP'){
    const colsTotalsHP   = colsTotalsNoHill.concat([{label:'Hill Œ£', key:'hill_sum', right:true, format:'mmss', nowrap:true}]);
    const colsAveragesHP = colsAveragesNoHill.concat([{label:'Avg Hill', key:'avgHill', right:true, format:'mmss', nowrap:true}]);
    renderTable('modeA_HP_tot', byA, colsTotalsHP, '‚Äî');
    renderTable('modeA_HP_avg', byA, colsAveragesHP, '‚Äî');
    renderTable('modeB_HP_tot', byB, colsTotalsHP, '‚Äî');
    renderTable('modeB_HP_avg', byB, colsAveragesHP, '‚Äî');
  } else if (mode==='SND'){
    renderTable('modeA_SND_tot', byA, colsTotalsNoHill, '‚Äî');
    renderTable('modeA_SND_avg', byA, colsAveragesNoHill, '‚Äî');
    renderTable('modeB_SND_tot', byB, colsTotalsNoHill, '‚Äî');
    renderTable('modeB_SND_avg', byB, colsAveragesNoHill, '‚Äî');
  } else if (mode==='CTRL'){
    renderTable('modeA_CTRL_tot', byA, colsTotalsNoHill, '‚Äî');
    renderTable('modeA_CTRL_avg', byA, colsAveragesNoHill, '‚Äî');
    renderTable('modeB_CTRL_tot', byB, colsTotalsNoHill, '‚Äî');
    renderTable('modeB_CTRL_avg', byB, colsAveragesNoHill, '‚Äî');
  }
}

/* ===== Wire up ===== */
el('applyBtn').onclick = ()=>{
  TEAM_A = el('teamA').value;
  TEAM_B = el('teamB').value;
  MODE_SEL = el('fMode').value;
  MAP_SEL  = el('fMap').value;

  const rowsA = currentScopeRows(TEAM_A);
  const rowsB = currentScopeRows(TEAM_B);

  renderOverallPanels(rowsA, rowsB);
  renderModePanels(rowsA, rowsB, 'HP');
  renderModePanels(rowsA, rowsB, 'SND');
  renderModePanels(rowsA, rowsB, 'CTRL');

  el('meta').textContent = `Scope ‚Äî Mode: ${MODE_SEL} ‚Ä¢ Map: ${MAP_SEL==='ALL'?'All':MAP_SEL} ‚Ä¢ A rows: ${rowsA.length} ‚Ä¢ B rows: ${rowsB.length}`;
  syncAllGroups();
};
el('resetBtn').onclick = (e)=>{
  e.preventDefault();
  if(!RAW.length) return;
  populateDropdowns();
  el('fMode').value = 'ALL';
  el('fMap').value  = 'ALL';
  MODE_SEL = 'ALL'; MAP_SEL = 'ALL';

  const rowsA = currentScopeRows(TEAM_A);
  const rowsB = currentScopeRows(TEAM_B);

  renderOverallPanels(rowsA, rowsB);
  renderModePanels(rowsA, rowsB, 'HP');
  renderModePanels(rowsA, rowsB, 'SND');
  renderModePanels(rowsA, rowsB, 'CTRL');

  el('meta').textContent = `Scope ‚Äî Mode: All ‚Ä¢ Map: All ‚Ä¢ A rows: ${rowsA.length} ‚Ä¢ B rows: ${rowsB.length}`;
  syncAllGroups();
};

/* Re-sync on resize and when folds open/close */
window.addEventListener('resize', ()=> { syncAllGroups(); });
document.addEventListener('toggle', (e)=>{
  if (e.target.tagName && e.target.tagName.toLowerCase() === 'details') {
    setTimeout(syncAllGroups, 0);
  }
}, true);

/* ===== Boot ===== */
(async function init(){
  const raw = await fetchAllKDA();
  RAW = raw.map(coerceRow).filter(r => r.Team && r.IGN && r.mode && r.Map);
  populateDropdowns();

  // Defaults
  el('fMode').value = 'ALL';
  el('fMap').value  = 'ALL';
  MODE_SEL = 'ALL'; MAP_SEL='ALL';

  const rowsA = currentScopeRows(TEAM_A);
  const rowsB = currentScopeRows(TEAM_B);

  renderOverallPanels(rowsA, rowsB);
  renderModePanels(rowsA, rowsB, 'HP');
  renderModePanels(rowsA, rowsB, 'SND');
  renderModePanels(rowsA, rowsB, 'CTRL');

  el('meta').textContent = `Scope ‚Äî Mode: All ‚Ä¢ Map: All ‚Ä¢ A rows: ${rowsA.length} ‚Ä¢ B rows: ${rowsB.length}`;
  syncAllGroups();
})();
</script>
</body>
</html>
